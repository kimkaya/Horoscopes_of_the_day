<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1080, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ìš´ì„¸ ê²°ê³¼ - Fortune</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 1980px;
            width: 1080px;
            margin: 0 auto;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }

        .container {
            background: transparent;
            padding: 60px 50px;
            border-radius: 0;
            box-shadow: none;
            width: 100%;
            max-width: 900px;
        }

        /* Receipt Style */
        .receipt {
            background: white;
            padding: 40px 30px;
            font-family: 'Courier New', monospace;
            border: none;
            position: relative;
        }

        .receipt::before,
        .receipt::after {
            content: '';
            position: absolute;
            left: -2px;
            right: -2px;
            height: 10px;
            background: linear-gradient(45deg, transparent 33.33%, white 33.33%, white 66.66%, transparent 66.66%),
                        linear-gradient(-45deg, transparent 33.33%, white 33.33%, white 66.66%, transparent 66.66%);
            background-size: 20px 40px;
            background-position: 0 -10px;
        }

        .receipt::before {
            display: none;
        }

        .receipt::after {
            display: none;
        }

        .receipt-header {
            text-align: center;
            border-bottom: 2px dashed #333;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .receipt-title {
            font-size: 42px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .receipt-subtitle {
            font-size: 24px;
            color: #666;
        }

        .receipt-section {
            margin: 20px 0;
            padding: 15px 0;
            border-bottom: 1px dashed #ccc;
        }

        .receipt-section:last-child {
            border-bottom: none;
        }

        .receipt-label {
            font-size: 22px;
            color: #666;
            margin-bottom: 10px;
        }

        .receipt-value {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .receipt-content {
            font-size: 24px;
            line-height: 2.0;
            white-space: pre-wrap;
        }

        .receipt-footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 25px;
            border-top: 3px dashed #333;
            font-size: 24px;
            color: #999;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        button {
            flex: 1;
            padding: 20px;
            border: 3px solid #333;
            background: white;
            border-radius: 8px;
            font-size: 26px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Courier New', monospace;
        }

        button:hover {
            background: #333;
            color: white;
        }

        .fortune-icon {
            font-size: 80px;
            margin: 15px 0;
        }

        .barcode {
            text-align: center;
            margin: 30px 0;
            font-family: 'Libre Barcode 128', cursive;
            font-size: 72px;
            letter-spacing: 3px;
        }

        .error {
            text-align: center;
            color: #d32f2f;
            padding: 20px;
        }

        /* í–‰ìš´ ë©”ì‹œì§€ ë°•ìŠ¤ */
        .fortune-box {
            background: white;
            border: 3px solid #333;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            font-size: 28px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* í™”ë©´ì— í‘œì‹œë  ê°ì‚¬ ë©”ì‹œì§€ */
        .thank-you-screen {
            background: white;
            border: 3px dashed white;
            padding: 70px 50px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .thank-you-screen h1 {
            font-size: 48px;
            margin-bottom: 40px;
            color: #333;
        }

        .thank-you-screen .bow-image {
            font-size: 150px;
            margin: 40px 0;
            animation: bow 2s ease-in-out infinite;
        }

        @keyframes bow {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(15deg); }
        }

        .thank-you-screen p {
            font-size: 28px;
            color: #666;
            margin-top: 30px;
        }

        /* AI ìš”ì•½ ìŠ¤íƒ€ì¼ */
        .ai-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: 3px solid white;
            padding: 25px;
            margin: 25px 0;
            border-radius: 12px;
            color: white;
        }

        .ai-summary-header {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ai-summary-content {
            font-size: 24px;
            line-height: 1.8;
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 8px;
        }

        .ai-summary-loading {
            text-align: center;
            font-size: 22px;
            opacity: 0.8;
        }

        .ai-summary-loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        /* í”„ë¦°íŠ¸ ì „ìš© ìŠ¤íƒ€ì¼ */
        @media print {
            body {
                background: white;
                padding: 0;
                width: auto;
                min-height: auto;
            }

            .container {
                box-shadow: none;
                padding: 20px;
            }

            /* í™”ë©´ìš© ê°ì‚¬ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸° */
            .thank-you-screen {
                display: none !important;
            }

            /* ì˜ìˆ˜ì¦ ë‚´ìš© í‘œì‹œ */
            #receipt-content {
                display: block !important;
            }

            .loading {
                display: none !important;
            }
        }

        /* í™”ë©´ì—ì„œëŠ” ì˜ìˆ˜ì¦ ë‚´ìš© ìˆ¨ê¸°ê¸° */
        @media screen {
            #receipt-content {
                display: none !important;
            }

            .thank-you-screen {
                display: block !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- í™”ë©´ì— í‘œì‹œë  ê°ì‚¬ ë©”ì‹œì§€ -->
        <div class="thank-you-screen" id="thankYouScreen" style="display: none;">
            <h1>ë‹¹ì‹ ì˜ í–‰ìš´ì„ ë¹•ë‹ˆë‹¤</h1>
            <div class="bow-image">ğŸ™‡</div>

            <!-- AI ìš”ì•½ ì˜ì—­ -->
            <div class="ai-summary" id="aiSummary" style="display: none;">
                <div class="ai-summary-header">
                    <span>âœ¨</span>
                    <span>AI ìš”ì•½</span>
                </div>
                <div class="ai-summary-content" id="aiSummaryContent">
                    <div class="ai-summary-loading">AIê°€ ìš´ì„¸ë¥¼ ìš”ì•½í•˜ê³  ìˆìŠµë‹ˆë‹¤</div>
                </div>
            </div>

            <p>ì˜ìˆ˜ì¦ì´ ì¶œë ¥ë©ë‹ˆë‹¤</p>
        </div>

        <!-- í”„ë¦°íŠ¸ìš© ì˜ìˆ˜ì¦ -->
        <div class="receipt" id="receipt">
            <div class="loading" id="loading">ìš´ì„¸ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘</div>
            <div id="receipt-content" style="display: none;"></div>
        </div>
    </div>

    <script>
        // URL íŒŒë¼ë¯¸í„° ê°€ì ¸ì˜¤ê¸°
        const urlParams = new URLSearchParams(window.location.search);
        const fortuneType = urlParams.get('type');
        const name = urlParams.get('name');
        const birthdate = urlParams.get('birthdate');
        const gender = urlParams.get('gender');
        const question = urlParams.get('question');

        // API í˜¸ì¶œ
        async function getFortune() {
            try {
                const response = await fetch('../Fortune_api/get_fortune.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        type: fortuneType,
                        name: name,
                        birthdate: birthdate,
                        gender: gender,
                        question: question
                    })
                });

                const data = await response.json();

                if (data.success) {
                    displayFortune(data.fortune);
                    // AI ìš”ì•½ ê°€ì ¸ì˜¤ê¸°
                    getAISummary(data.fortune);
                } else {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('thankYouScreen').innerHTML = `<div class="error">${data.message}</div>`;
                    document.getElementById('thankYouScreen').style.display = 'block';
                }
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('thankYouScreen').innerHTML = `<div class="error">ìš´ì„¸ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>`;
                document.getElementById('thankYouScreen').style.display = 'block';
            }
        }

        // AI ìš”ì•½ ê°€ì ¸ì˜¤ê¸°
        async function getAISummary(fortune) {
            try {
                // AI ìš”ì•½ ì˜ì—­ í‘œì‹œ
                document.getElementById('aiSummary').style.display = 'block';

                const response = await fetch('../Fortune_api/summarize_fortune.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        type: fortuneType,
                        fortune: fortune
                    })
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('aiSummaryContent').innerHTML = data.summary;
                } else {
                    // API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì€ ê²½ìš° AI ìš”ì•½ ì˜ì—­ ìˆ¨ê¸°ê¸°
                    if (data.message && data.message.includes('API í‚¤')) {
                        document.getElementById('aiSummary').style.display = 'none';
                        console.log('AI ìš”ì•½: ' + data.message);
                    } else {
                        document.getElementById('aiSummaryContent').innerHTML = 'ìš”ì•½ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                    }
                }
            } catch (error) {
                console.error('AI ìš”ì•½ ì˜¤ë¥˜:', error);
                document.getElementById('aiSummary').style.display = 'none';
            }
        }

        function displayFortune(fortune) {
            const now = new Date();
            const dateStr = now.toLocaleDateString('ko-KR');
            const timeStr = now.toLocaleTimeString('ko-KR');

            let icon = 'ğŸ”®';
            let title = 'ìš´ì„¸';

            switch(fortuneType) {
                case 'daily':
                    icon = 'â˜€ï¸';
                    title = 'ì˜¤ëŠ˜ì˜ ìš´ì„¸';
                    break;
                case 'tarot':
                    icon = 'ğŸƒ';
                    title = 'íƒ€ë¡œ';
                    break;
                case 'saju':
                    icon = 'ğŸ“¿';
                    title = 'ì‚¬ì£¼';
                    break;
                case 'omikuji':
                    icon = 'ğŸ‹';
                    title = 'ìš´ì„¸ ë½‘ê¸°';
                    break;
            }

            // í™”ë©´ìš© ê°ì‚¬ ë©”ì‹œì§€ì— ìš´ì„¸ ê²°ê³¼ ìš”ì•½ ì¶”ê°€
            let fortuneSummary = '';
            if (fortune.overall) {
                fortuneSummary = fortune.overall.substring(0, 100) + (fortune.overall.length > 100 ? '...' : '');
            } else if (fortune.overall_interpretation) {
                fortuneSummary = fortune.overall_interpretation.substring(0, 100) + (fortune.overall_interpretation.length > 100 ? '...' : '');
            } else if (fortune.interpretation) {
                fortuneSummary = fortune.interpretation.substring(0, 100) + (fortune.interpretation.length > 100 ? '...' : '');
            } else if (fortune.card_meaning) {
                fortuneSummary = fortune.card_meaning.substring(0, 100) + (fortune.card_meaning.length > 100 ? '...' : '');
            } else if (fortune.fortune_text) {
                fortuneSummary = fortune.fortune_text.substring(0, 100) + (fortune.fortune_text.length > 100 ? '...' : '');
            }

            document.getElementById('thankYouScreen').innerHTML = `
                <h1>ë‹¹ì‹ ì˜ í–‰ìš´ì„ ë¹•ë‹ˆë‹¤</h1>
                <div class="bow-image">ğŸ™‡</div>
                ${fortuneSummary ? `<div style="font-size: 22px; color: #666; margin: 20px 0; line-height: 1.6;">${fortuneSummary}</div>` : ''}
                <p>ì˜ìˆ˜ì¦ì´ ì¶œë ¥ë©ë‹ˆë‹¤</p>
            `;

            // ì˜ìˆ˜ì¦ ë‚´ìš© ìƒì„± (í”„ë¦°íŠ¸ìš©)
            let receiptHtml = `
                <div class="receipt-header">
                    <div class="fortune-icon">${icon}</div>
                    <div class="receipt-title">${title}</div>
                    <div class="receipt-subtitle">FORTUNE RECEIPT</div>
                </div>

                <div class="receipt-section">
                    <div class="receipt-label">ì¼ì‹œ</div>
                    <div class="receipt-value">${dateStr} ${timeStr}</div>
                </div>

                <div class="receipt-section">
                    <div class="receipt-label">ì´ë¦„</div>
                    <div class="receipt-value">${name}</div>
                </div>
            `;

            // ìƒë…„ì›”ì¼ ì¶”ê°€
            if (birthdate) {
                receiptHtml += `
                    <div class="receipt-section">
                        <div class="receipt-label">ìƒë…„ì›”ì¼</div>
                        <div class="receipt-value">${birthdate}</div>
                    </div>
                `;
            }

            // ë³„ìë¦¬ ì¶”ê°€ (ì˜¤ëŠ˜ì˜ ìš´ì„¸ì¸ ê²½ìš°)
            if (fortuneType === 'daily' && fortune.zodiac_sign) {
                receiptHtml += `
                    <div class="receipt-section">
                        <div class="receipt-label">ë³„ìë¦¬</div>
                        <div class="receipt-value">${fortune.zodiac_sign}</div>
                    </div>
                `;
            }

            // ì„±ë³„ ì¶”ê°€
            if (gender) {
                const genderMap = {
                    'male': 'ë‚¨ì„±',
                    'female': 'ì—¬ì„±',
                    'other': 'ê¸°íƒ€'
                };
                receiptHtml += `
                    <div class="receipt-section">
                        <div class="receipt-label">ì„±ë³„</div>
                        <div class="receipt-value">${genderMap[gender] || gender}</div>
                    </div>
                `;
            }

            // ì§ˆë¬¸ ì¶”ê°€ (íƒ€ë¡œ ë“±)
            if (question) {
                receiptHtml += `
                    <div class="receipt-section">
                        <div class="receipt-label">ì§ˆë¬¸</div>
                        <div class="receipt-content">${question}</div>
                    </div>
                `;
            }

            // íƒ€ë¡œ ì¹´ë“œ 3ì¥ í‘œì‹œ
            if (fortune.cards && Array.isArray(fortune.cards)) {
                fortune.cards.forEach((card, index) => {
                    receiptHtml += `
                        <div class="receipt-section">
                            <div class="receipt-label">${card.position} ì¹´ë“œ</div>
                            <div class="receipt-value">${card.card_name}</div>
                            <div class="receipt-content">${card.card_meaning}</div>
                        </div>
                    `;
                });

                // íƒ€ë¡œ ì¢…í•© í•´ì„
                if (fortune.overall_interpretation) {
                    receiptHtml += `
                        <div class="receipt-section">
                            <div class="receipt-label">ì¢…í•© í•´ì„</div>
                            <div class="receipt-content">${fortune.overall_interpretation}</div>
                        </div>
                    `;
                }
            }

            // ì‚¬ì£¼ ê²°ê³¼ í‘œì‹œ
            if (fortuneType === 'saju') {
                if (fortune.zodiac_sign) {
                    receiptHtml += `
                        <div class="receipt-section">
                            <div class="receipt-label">ë </div>
                            <div class="receipt-value">${fortune.zodiac_sign}</div>
                        </div>
                    `;
                }

                if (fortune.element) {
                    receiptHtml += `
                        <div class="receipt-section">
                            <div class="receipt-label">ì˜¤í–‰</div>
                            <div class="receipt-value">${fortune.element}</div>
                        </div>
                    `;
                }

                if (fortune.personality_text) {
                    receiptHtml += `
                        <div class="receipt-section">
                            <div class="receipt-label">ì„±ê²©</div>
                            <div class="receipt-content">${fortune.personality_text}</div>
                        </div>
                    `;
                }

                if (fortune.fortune_text) {
                    receiptHtml += `
                        <div class="receipt-section">
                            <div class="receipt-label">ìš´ì„¸</div>
                            <div class="receipt-content">${fortune.fortune_text}</div>
                        </div>
                    `;
                }

                if (fortune.career_text) {
                    receiptHtml += `
                        <div class="receipt-section">
                            <div class="receipt-label">ì¬ë¬¼ìš´</div>
                            <div class="receipt-content">${fortune.career_text}</div>
                        </div>
                    `;
                }

                if (fortune.love_text) {
                    receiptHtml += `
                        <div class="receipt-section">
                            <div class="receipt-label">ì• ì •ìš´</div>
                            <div class="receipt-content">${fortune.love_text}</div>
                        </div>
                    `;
                }
            }

            // ìš´ì„¸ ë½‘ê¸° (omikuji) ê²°ê³¼ í‘œì‹œ
            if (fortuneType === 'omikuji') {
                if (fortune.fortune_level) {
                    // í•œì ì˜†ì— í•œê¸€ ë°œìŒ ì¶”ê°€
                    const fortuneLevelMap = {
                        'å¤§å‰': 'å¤§å‰ (ëŒ€ê¸¸)',
                        'ä¸­å‰': 'ä¸­å‰ (ì¤‘ê¸¸)',
                        'å°å‰': 'å°å‰ (ì†Œê¸¸)',
                        'å‰': 'å‰ (ê¸¸)',
                        'æœ«å‰': 'æœ«å‰ (ë§ê¸¸)',
                        'åŠå‰': 'åŠå‰ (ë°˜ê¸¸)',
                        'å‡¶': 'å‡¶ (í‰)',
                        'å°å‡¶': 'å°å‡¶ (ì†Œí‰)',
                        'å¤§å‡¶': 'å¤§å‡¶ (ëŒ€í‰)'
                    };
                    const displayLevel = fortuneLevelMap[fortune.fortune_level] || fortune.fortune_level;

                    receiptHtml += `
                        <div class="receipt-section">
                            <div class="receipt-label">ê¸¸í‰</div>
                            <div class="receipt-value">${displayLevel}</div>
                        </div>
                    `;
                }

                if (fortune.fortune_text) {
                    receiptHtml += `
                        <div class="receipt-section">
                            <div class="receipt-label">ìš´ì„¸</div>
                            <div class="receipt-content">${fortune.fortune_text}</div>
                        </div>
                    `;
                }

                if (fortune.wish_text) {
                    receiptHtml += `
                        <div class="receipt-section">
                            <div class="receipt-label">ì†Œì›</div>
                            <div class="receipt-content">${fortune.wish_text}</div>
                        </div>
                    `;
                }

                if (fortune.health_text) {
                    receiptHtml += `
                        <div class="receipt-section">
                            <div class="receipt-label">ê±´ê°•</div>
                            <div class="receipt-content">${fortune.health_text}</div>
                        </div>
                    `;
                }

                if (fortune.business_text) {
                    receiptHtml += `
                        <div class="receipt-section">
                            <div class="receipt-label">í•™ì—…/ì‚¬ì—…</div>
                            <div class="receipt-content">${fortune.business_text}</div>
                        </div>
                    `;
                }

                if (fortune.travel_text) {
                    receiptHtml += `
                        <div class="receipt-section">
                            <div class="receipt-label">ì—¬í–‰</div>
                            <div class="receipt-content">${fortune.travel_text}</div>
                        </div>
                    `;
                }
            }

            // ì˜¤ëŠ˜ì˜ ìš´ì„¸ (daily) ê²°ê³¼ í‘œì‹œ
            if (fortuneType === 'daily') {
                if (fortune.overall) {
                    receiptHtml += `
                        <div class="receipt-section">
                            <div class="receipt-label">ì¢…í•© ìš´ì„¸</div>
                            <div class="receipt-content">${fortune.overall}</div>
                        </div>
                    `;
                }

                if (fortune.lucky_item) {
                    receiptHtml += `
                        <div class="receipt-section">
                            <div class="receipt-label">í–‰ìš´ì˜ ì•„ì´í…œ</div>
                            <div class="receipt-value">${fortune.lucky_item}</div>
                        </div>
                    `;
                }

                if (fortune.lucky_color) {
                    receiptHtml += `
                        <div class="receipt-section">
                            <div class="receipt-label">í–‰ìš´ì˜ ìƒ‰ìƒ</div>
                            <div class="receipt-value">${fortune.lucky_color}</div>
                        </div>
                    `;
                }

                if (fortune.lucky_number) {
                    receiptHtml += `
                        <div class="receipt-section">
                            <div class="receipt-label">í–‰ìš´ì˜ ìˆ«ì</div>
                            <div class="receipt-value">${fortune.lucky_number}</div>
                        </div>
                    `;
                }

                if (fortune.advice) {
                    receiptHtml += `
                        <div class="receipt-section">
                            <div class="receipt-label">ì¡°ì–¸</div>
                            <div class="receipt-content">${fortune.advice}</div>
                        </div>
                    `;
                }
            }

            // ì˜ìˆ˜ì¦ í‘¸í„°
            receiptHtml += `
                <div class="barcode">||||| || |||||</div>
                <div class="fortune-box">
                    ë‹¹ì‹ ì˜ í–‰ìš´ì„ ë¹•ë‹ˆë‹¤ ğŸ™‡
                </div>
                <div class="receipt-footer">
                    ì•ìœ¼ë¡œ ì¢‹ì€ ì¼ë§Œ ê°€ë“í•˜ì‹œê¸¸<br>
                    ë‹¹ì‹ ì˜ ë¯¸ë˜ì— í–‰ìš´ì´ í•¨ê»˜í•˜ê¸¸<br>
                    ëª¨ë“  ì¼ì´ ìˆœì¡°ë¡­ê²Œ í’€ë¦¬ê¸°ë¥¼<br>
                    ë‹¹ì‹ ì˜ ê¿ˆì´ ëª¨ë‘ ì´ë£¨ì–´ì§€ê¸¸<br><br>
                    ì˜¤ëŠ˜ë„ í–‰ë³µí•œ í•˜ë£¨ ë˜ì„¸ìš” âœ¨
                </div>
            `;

            // ë¡œë”© ìˆ¨ê¸°ê¸°
            document.getElementById('loading').style.display = 'none';

            // ì˜ìˆ˜ì¦ ë‚´ìš© ì„¤ì • (í”„ë¦°íŠ¸ìš©)
            document.getElementById('receipt-content').innerHTML = receiptHtml;
            document.getElementById('receipt-content').style.display = 'block';

            // í™”ë©´ì— ê°ì‚¬ ë©”ì‹œì§€ í‘œì‹œ (ì´ë¯¸ ìœ„ì—ì„œ ì„¤ì •ë¨)
            document.getElementById('thankYouScreen').style.display = 'block';

            // ìë™ ì¸ì‡„
            setTimeout(() => {
                window.print();

                // ì¸ì‡„ í›„ ë©”ì¸ í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸° (3ì´ˆ í›„)
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 3000);
            }, 500);
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìš´ì„¸ ê°€ì ¸ì˜¤ê¸°
        getFortune();
    </script>
</body>
</html>
